// ===== EVENT DATA =====
const eventData = {
    chazil: {
        title: 'CHAZIL',
        date: '25 Avril 2025',
        location: 'New Morning, Paris',
        type: 'Concert',
        time: '19h30 - 23h00',
        price: '25€ / 29€',
        image: './assets/img/banner-chazil.webp',
        video: '8hH7f3WKHyY',
        description: `
            <br />       
            <h3>1ère partie : Rabie Houti</h3>
            <p>Née de la volonté de Rabie Houti, violoniste reconnu de la scène oranaise dont le répertoire arabo-andalou a toujours été une invitation au voyage. À peine ses valises posées sur les bords du Lez, son violon ne tarde pas à rassembler autour de lui des musiciens de tout horizon avide de partage. De cette rencontre naîtra le groupe Rabie Houti Band qui propose aujourd'hui une musique de fusion riche et variée, mêlant à la fois la douceur orientale d'airs arabo-andalous revisités, l'énergie percutante d'une gamme de blues, le groove imparable d'un rythme afrobeat, la légèreté d'un swing. Rien ne se perd, tout se transforme. À partir des diverses influences musicales de chacun, le Rabie Houti Band crée un paysage sonore unique, car multicolore, propice à la joie, à la fête et au voyage.</p><br /><br />
            
            <h3>Concert : Chazil</h3>
            <p>Chanteur et compositeur, Chazil Adlene Bahloul incarne une identité musicale profondément enracinée dans l'essence de l'Algérie. Né à Constantine, il grandit au cœur de sa Casbah, où il développe une passion pour la musique en puisant dans l'âme de son quartier populaire. Sa voix grave, à la fois mélancolique et porteuse d'espoir, résonne comme un écho des émotions de l'Algérie profonde.</p><br />
            <p>Chazil puise son inspiration dans les chants traditionnels algériens, du Aïssaoua, Malouf et El Wesfane à l'Est, au Gnaoui au Sud, en passant par le Chaâbi au Nord et le Raï à l'Ouest, dont il tombe profondément amoureux. Animé par une soif de fusion musicale, il explore également des styles internationaux comme le Flamenco, le Fado, le Reggae et la musique turque, créant un son innovant et universel. Ses voyages lui ont permis de constater l'impact de la musique algérienne à l'international et de séduire un public toujours plus large.</p><br />
            <p>En février 2025, il marque un tournant dans sa carrière en se produisant au Palais des Congrès de Paris devant plus de 4000 personnes, lors d'un événement emblématique du Raï Nation. Fort de ce succès, il continue son ascension et sera de retour sur scène à Paris le 25 avril 2025.</p><br />
            <p>À travers ses performances, Chazil fait rayonner à nouveau le vieux RAI, sur la scène nationale et internationale, en ajoutant sa touche de fraîcheur et de modernité.</p>
        `,
        program: [
            { time: '19h30', title: 'Ouverture des portes', description: 'Entrez dans l\'univers musical et installez-vous confortablement pour une soirée inoubliable.' },
            { time: '20h30', title: 'Rabie Houti', description: 'Lancement de la soirée avec le talent exceptionnel de Rabie Houti, violoniste renommé, pour un début plein de magie et de voyage musical.' },
            { time: '20h50', title: 'Chazil (Première partie)', description: 'Plongez dans l\'ambiance avec la première partie du concert de Chazil, qui promet émotions et rythmes envoûtants.' },
            { time: '21h40', title: 'Pause / Intermède', description: 'Profitez d\'un moment pour vous détendre, boire une boisson ou grignoter un snack avant la deuxième partie.' },
            { time: '22h00', title: 'Chazil (Deuxième partie)', description: 'Rejoignez Chazil pour la deuxième partie du concert et laissez-vous emporter par l\'énergie et la passion sur scène.' },
            { time: '23h00', title: 'Clôture de la soirée', description: 'Une fin en beauté pour une soirée mémorable, remplie de musique, de joie et de souvenirs.' }
        ],
        gallery: [
            './assets/img/event-3-1.webp',
            './assets/img/event-3-2.webp',
            './assets/img/event-3-3.webp',
            './assets/img/event-3-4.webp',
            './assets/img/event-3-5.webp',
            './assets/img/event-3-6.webp',
            './assets/img/event-3-7.webp',
            './assets/img/event-3-8.webp',
            './assets/img/event-3-9.webp',
            './assets/img/event-3-10.webp',
            './assets/img/event-3-11.webp',
            './assets/img/event-3-12.webp',
            './assets/img/event-3-13.webp',
            './assets/img/event-3-14.webp',
            './assets/img/event-3-15.webp',
            './assets/img/event-3-16.webp',
            './assets/img/event-3-17.webp',
            './assets/img/event-3-18.webp'
        ]
    },
    babylonedjamtimoh: {
        title: 'BABYLONE, DJAM & TIMOH',
        date: '15 Février 2025',
        location: 'Cabaret Sauvage, Paris',
        type: 'Concert',
        time: '18h30 - 22h30',
        price: '35€ / 38€',
        image: './assets/img/banner-babylone-djam-timoh.webp',
        video: 'sEyDABFlDUI',
        description: `
            <br />
            <h3>Djam x TiMoh - Premier concert </h3><br />
            <p>Les frères <strong>Djam x TiMoh</strong>, artistes phares de la nouvelle scène algérienne ont concocté un tout nouveau projet musical en collaboration avec le talentueux <strong>Zajib</strong>, guitariste de <strong>Sidi Bel Abbès</strong>.</p><br />
            <p>Le résultat est une fusion explosive où les influences andalouses, chaabi, africaines, et reggae se marient à une composante électro élégante et futuriste.</p><br />
            <p>L'expérience LIVE commencée en Algérie, se poursuit en France et au Canada...</p><br />
            <p>Porté par un featuring avec <strong>Djalil Palermo</strong>, le premier single, "<strong>Zman Ydor</strong>" (sorti en mars 2024), extrait de leur EP à venir, a déjà atteint un impressionnant 20 millions de vues sur YouTube !</p><br /><br />
            
            <h3>Babylone - Deuxième concert</h3><br />
            <p>Icône de la scène musicale algérienne depuis 2012, <strong>BABYLONE</strong> séduit avec son style unique "<strong>Dziri</strong>", alliant pop urbaine et sonorités maghrébines. Porté par la voix envoûtante d'Amine, le groupe interprétera ses morceaux emblématiques tels que "<strong>Zina</strong>" (plus de 222 millions de vues sur YouTube), "<strong>Choufou l'amour ma dar fiya</strong>", et bien d'autres pépites.</p><br />
            <p>Un événement musical à ne pas manquer!</p><br />
            <p>Laissez vous transporter par les rythmes ensorcelants de la musique algérienne pour une soirée mémorable.</p>
        `,
        program: [
            { time: '18h30', title: 'Ouverture des portes', description: 'Accueil du public et installation pour une soirée pleine de musique et de surprises.' },
            { time: '19h30', title: 'Animation', description: 'Ramzi Zanga Crazy chauffe l\'ambiance avec son humour et ses animations.' },
            { time: '19h45', title: 'Concert 1 : Djam & Timoh', description: 'Avec invités surprises exceptionnels : Fianso & DJ Kore. Préparez-vous à vibrer !' },
            { time: '21h10', title: 'Concert 2 : Babylone', description: 'Clôture de la soirée avec Babylone et la légendaire Cheba Fadela en invité surprise.' },
            { time: '22h30', title: 'Clôture de la soirée', description: 'Une fin en beauté pour une soirée mémorable, remplie de musique, de joie et de souvenirs.' }
        ],
        gallery: [
            './assets/img/event-2-1.webp',
            './assets/img/event-2-2.webp',
            './assets/img/event-2-3.webp',
            './assets/img/event-2-4.webp',
            './assets/img/event-2-5.webp',
            './assets/img/event-2-6.webp',
            './assets/img/event-2-7.webp',
            './assets/img/event-2-8.webp',
            './assets/img/event-2-9.webp',
            './assets/img/event-2-10.webp',
        ]
    },
    tarhaninefreeklane: {
        title: 'CHEMSOU FREEKLANE & KADER TARHANINE',
        date: '15 Septembre 2024',
        location: 'Cabaret Sauvage, Paris',
        type: 'Concert',
        time: '16h00 - 20h00',
        price: '25€ / 33€',
        image: './assets/img/banner-tarhaninel-freeklane.webp',
        video: 'c7UwD-7BBt0',
        description: `
            <br />
            <h3>Kader Tarhanine - Premier concert </h3><br />
            <p><strong>Kader Tarhanine</strong>, étoile montante de la musique moderne <strong>touareg</strong>, captive un public de plus en plus large grâce à son talent inné et à sa fraîcheur artistique. Sa musique fusionne habilement les rythmes traditionnels <strong>touaregs</strong> avec des influences rock, créant un son unique. Les paroles poétiques de ses chansons, souvent en tamacheq ou en arabe, ajoutent une dimension profonde à sa musique, touchant les cœurs de ceux qui l'écoutent.</p><br />
            <p><strong>Kader Tarhanine</strong> est également connu pour ses performances scéniques impressionnantes et sa maîtrise exceptionnelle de la guitare.<p/><br />
            <p>En tant qu'ambassadeur de la culture <strong>touareg</strong>, <strong>Kader</strong> utilise sa musique pour transcender les frontières et promouvoir la paix dans les régions sahélo-sahariennes et le Maghreb.<p/><br /><br />
            
            <h3>Chemsou Freeklane - Deuxième concert </h3><br />
            <p><strong>Chemsou Freeklane</strong> , une figure emblématique de la musique <strong>algérienne</strong> moderne, continue de marquer les esprits après le succès immense des deux albums «<strong>Lalla Mira</strong>» et «<strong>Nomad</strong>» avec le groupe <strong>Freeklane</strong>.</p><br />
            <p>Depuis 2016, <strong>Chemsou</strong> poursuit une carrière solo en explorant de nouveaux styles musicaux et des thèmes variés. Ses chansons rencontrent un grand succès dans les pays arabes et maghrébins, et chaque nouvelle sortie fait sensation sur la toile.</p><br />
            <p>Laissez-vous emporter par les rythmes envoûtants de la musique <strong>touareg</strong> et <strong>algérienne</strong> pour une soirée inoubliable.</p>
        `,
        program: [
            { time: '16h00', title: 'Ouverture des portes', description: 'Accueil du public et installation pour une après-midi musicale et festive.' },
            { time: '17h00', title: 'Humour & Animation', description: 'Ramzi Zanga Crazy met l\'ambiance avec ses sketches et animations hilarantes.' },
            { time: '17h15', title: 'Concert 1 – Kader Tarhanine', description: 'Plongez dans l\'univers captivant de Kader Tarhanine et laissez-vous emporter par la musique.' },
            { time: '18h30', title: 'Pause / Humour', description: 'Un moment de détente et de rire avec Ramzi Zanga Crazy avant la deuxième partie.' },
            { time: '18h45', title: 'Concert 2 – Chemsou Freeklane', description: 'Clôturez l\'après-midi en beauté avec le concert énergique et envoûtant de Chemsou Freeklane.' },
            { time: '20h00', title: 'Clôture de la soirée', description: 'Une fin en beauté pour une soirée mémorable, remplie de musique, de joie et de souvenirs.' }
        ],
        gallery: [
            './assets/img/event-1-1.webp',
            './assets/img/event-1-2.webp',
            './assets/img/event-1-3.webp',
            './assets/img/event-1-4.webp',
            './assets/img/event-1-5.webp',
            './assets/img/event-1-6.webp',
            './assets/img/event-1-7.webp',
            './assets/img/event-1-8.webp',
            './assets/img/event-1-9.webp',
            './assets/img/event-1-10.webp',
            './assets/img/event-1-11.webp',
            './assets/img/event-1-12.webp',
            './assets/img/event-1-13.webp',
            './assets/img/event-1-14.webp',
            './assets/img/event-1-15.webp'
        ]
    }
};

// ===== GALLERY CAROUSEL CLASS =====
class GalleryCarousel {
    constructor(containerId, images) {
        this.container = document.getElementById(containerId);
        this.images = images || [];
        this.currentIndex = 0;
        this.isTransitioning = false;
        this.autoplayInterval = null;
        this.autoplayDelay = 4000;
        this.touchStartX = 0;
        this.touchEndX = 0;
        this.isModalOpen = false;
        
        if (this.images.length > 0) {
            this.init();
        }
    }
    
    init() {
        if (!this.container) {
            console.error('Carousel container not found');
            return;
        }
        
        this.createElements();
        this.bindEvents();
        this.updateDisplay();
        
        // Only start autoplay if more than 1 image
        if (this.images.length > 1) {
            this.startAutoplay();
        }
        
        this.preloadImages();
    }
    
    createElements() {
        // Get carousel elements
        this.track = this.container.querySelector('#carouselTrack');
        this.dotsContainer = this.container.querySelector('#carouselDots');
        this.thumbnailsContainer = this.container.querySelector('#carouselThumbnails');
        this.prevBtn = this.container.querySelector('#prevBtn');
        this.nextBtn = this.container.querySelector('#nextBtn');
        this.progressBar = this.container.querySelector('#progressBar');
        this.currentSlideSpan = this.container.querySelector('#currentSlide');
        this.totalSlidesSpan = this.container.querySelector('#totalSlides');
        
        // Clear existing content
        this.track.innerHTML = '';
        this.dotsContainer.innerHTML = '';
        this.thumbnailsContainer.innerHTML = '';
        
        // Create slides
        this.images.forEach((image, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.innerHTML = `
                <img src="${image}" alt="Photo ${index + 1}" loading="${index === 0 ? 'eager' : 'lazy'}" />
            `;
            this.track.appendChild(slide);
        });
        
        // Create dots
        this.images.forEach((_, index) => {
            const dot = document.createElement('button');
            dot.className = 'carousel-dot';
            dot.setAttribute('aria-label', `Aller à l'image ${index + 1}`);
            dot.addEventListener('click', () => this.goToSlide(index));
            this.dotsContainer.appendChild(dot);
        });
        
        // Create thumbnails
        this.images.forEach((image, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = 'carousel-thumbnail';
            thumbnail.innerHTML = `<img src="${image}" alt="Miniature ${index + 1}" loading="lazy" />`;
            thumbnail.addEventListener('click', () => this.goToSlide(index));
            this.thumbnailsContainer.appendChild(thumbnail);
        });
        
        // Update total slides counter
        this.totalSlidesSpan.textContent = this.images.length;
        
        // Get modal elements
        this.modal = document.getElementById('galleryModal');
        this.modalImage = document.getElementById('modalImage');
        this.modalCurrentSlide = document.getElementById('modalCurrentSlide');
        this.modalTotalSlides = document.getElementById('modalTotalSlides');
        this.modalCloseBtn = document.getElementById('modalCloseBtn');
        this.modalPrevBtn = document.getElementById('modalPrevBtn');
        this.modalNextBtn = document.getElementById('modalNextBtn');
        
        if (this.modalTotalSlides) {
            this.modalTotalSlides.textContent = this.images.length;
        }
    }
    
    bindEvents() {
        // Navigation buttons
        this.prevBtn?.addEventListener('click', () => this.previousSlide());
        this.nextBtn?.addEventListener('click', () => this.nextSlide());
        
        // Touch events for mobile
        this.track.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
        this.track.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });
        
        // Keyboard navigation
        this.container.addEventListener('keydown', (e) => this.handleKeyDown(e));
        
        // Modal events
        this.track.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG') {
                this.openModal();
            }
        });
        
        // Modal navigation
        this.modalCloseBtn?.addEventListener('click', () => this.closeModal());
        this.modalPrevBtn?.addEventListener('click', () => this.modalPreviousSlide());
        this.modalNextBtn?.addEventListener('click', () => this.modalNextSlide());
        
        // Close modal events
        this.modal?.addEventListener('click', (e) => {
            if (e.target === this.modal) {
                this.closeModal();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isModalOpen) {
                this.closeModal();
            }
        });
        
        // Autoplay control
        this.container.addEventListener('mouseenter', () => this.stopAutoplay());
        this.container.addEventListener('mouseleave', () => this.startAutoplay());
        
        // Visibility change handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.stopAutoplay();
            } else if (!this.isModalOpen && this.images.length > 1) {
                this.startAutoplay();
            }
        });
    }
    
    handleTouchStart(e) {
        this.touchStartX = e.touches[0].clientX;
        this.stopAutoplay();
    }
    
    handleTouchEnd(e) {
        this.touchEndX = e.changedTouches[0].clientX;
        this.handleSwipe();
        if (this.images.length > 1) {
            this.startAutoplay();
        }
    }
    
    handleSwipe() {
        const swipeThreshold = 50;
        const diff = this.touchStartX - this.touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                this.nextSlide();
            } else {
                this.previousSlide();
            }
        }
    }
    
    handleKeyDown(e) {
        switch (e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                this.previousSlide();
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.nextSlide();
                break;
            case 'Home':
                e.preventDefault();
                this.goToSlide(0);
                break;
            case 'End':
                e.preventDefault();
                this.goToSlide(this.images.length - 1);
                break;
        }
    }
    
    goToSlide(index) {
        if (this.isTransitioning || index === this.currentIndex || this.images.length <= 1) return;
        
        this.isTransitioning = true;
        this.currentIndex = index;
        
        // Ensure index is within bounds (infinite loop)
        if (this.currentIndex < 0) {
            this.currentIndex = this.images.length - 1;
        } else if (this.currentIndex >= this.images.length) {
            this.currentIndex = 0;
        }
        
        this.updateDisplay();
        
        // Reset transition flag
        setTimeout(() => {
            this.isTransitioning = false;
        }, 600);
    }
    
    nextSlide() {
        this.goToSlide(this.currentIndex + 1);
    }
    
    previousSlide() {
        this.goToSlide(this.currentIndex - 1);
    }
    
    updateDisplay() {
        // Update track position
        const translateX = -this.currentIndex * 100;
        this.track.style.transform = `translateX(${translateX}%)`;
        
        // Update dots
        const dots = this.dotsContainer.querySelectorAll('.carousel-dot');
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === this.currentIndex);
        });
        
        // Update thumbnails
        const thumbnails = this.thumbnailsContainer.querySelectorAll('.carousel-thumbnail');
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.classList.toggle('active', index === this.currentIndex);
        });
        
        // Scroll active thumbnail into view - ONLY if gallery section is visible
        const activeThumbnail = thumbnails[this.currentIndex];
        if (activeThumbnail && this.thumbnailsContainer) {
            // Check if the gallery section is visible in viewport
            const gallerySection = document.querySelector('.gallery-section');
            if (gallerySection) {
                const galleryRect = gallerySection.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                
                // Only scroll thumbnail if gallery section is at least partially visible
                const isGalleryVisible = galleryRect.top < viewportHeight && galleryRect.bottom > 0;
                
                if (isGalleryVisible) {
                    const containerRect = this.thumbnailsContainer.getBoundingClientRect();
                    const thumbnailRect = activeThumbnail.getBoundingClientRect();
                    
                    // Only scroll thumbnail if it's outside the visible area of its container
                    if (thumbnailRect.left < containerRect.left || thumbnailRect.right > containerRect.right) {
                        activeThumbnail.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }
                }
            }
        }
        
        // Update progress bar
        const progressWidth = ((this.currentIndex + 1) / this.images.length) * 100;
        this.progressBar.style.width = `${progressWidth}%`;
        
        // Update counter
        this.currentSlideSpan.textContent = this.currentIndex + 1;
        
        // Update navigation state
        this.updateNavigationState();
        
        // Announce to screen readers
        this.announceSlideChange();
    }
    
    updateNavigationState() {
        // Handle single image case
        if (this.images.length <= 1) {
            if (this.prevBtn) this.prevBtn.style.display = 'none';
            if (this.nextBtn) this.nextBtn.style.display = 'none';
            if (this.dotsContainer) this.dotsContainer.style.display = 'none';
            this.stopAutoplay();
            return;
        }
        
        // Show navigation for multiple images
        if (this.prevBtn) this.prevBtn.style.display = 'flex';
        if (this.nextBtn) this.nextBtn.style.display = 'flex';
        if (this.dotsContainer) this.dotsContainer.style.display = 'flex';
    }
    
    announceSlideChange() {
        let announcement = document.getElementById('carousel-announcement');
        if (!announcement) {
            announcement = document.createElement('div');
            announcement.id = 'carousel-announcement';
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.style.cssText = `
                position: absolute;
                left: -10000px;
                width: 1px;
                height: 1px;
                overflow: hidden;
            `;
            document.body.appendChild(announcement);
        }
        
        announcement.textContent = `Image ${this.currentIndex + 1} sur ${this.images.length}`;
    }
    
    startAutoplay() {
        if (this.autoplayInterval || this.images.length <= 1) return;
        
        this.autoplayInterval = setInterval(() => {
            if (!this.isModalOpen && !this.isTransitioning) {
                this.nextSlide();
            }
        }, this.autoplayDelay);
    }
    
    stopAutoplay() {
        if (this.autoplayInterval) {
            clearInterval(this.autoplayInterval);
            this.autoplayInterval = null;
        }
    }
    
    preloadImages() {
        this.images.forEach((src, index) => {
            if (index <= 2) {
                const img = new Image();
                img.src = src;
            }
        });
    }
    
    // Modal methods
    openModal() {
        this.isModalOpen = true;
        if (this.modal) {
            this.modal.classList.add('active');
            this.updateModalDisplay();
        }
        this.stopAutoplay();
        
        document.body.style.overflow = 'hidden';
        
        if (this.modal) {
            this.modal.focus();
        }
    }
    
    closeModal() {
        this.isModalOpen = false;
        if (this.modal) {
            this.modal.classList.remove('active');
        }
        
        document.body.style.overflow = '';
        
        if (this.images.length > 1) {
            this.startAutoplay();
        }
        
        this.container.focus();
    }
    
    modalNextSlide() {
        this.goToSlide(this.currentIndex + 1);
        this.updateModalDisplay();
    }
    
    modalPreviousSlide() {
        this.goToSlide(this.currentIndex - 1);
        this.updateModalDisplay();
    }
    
    updateModalDisplay() {
        if (this.modalImage && this.images[this.currentIndex]) {
            this.modalImage.src = this.images[this.currentIndex];
            this.modalImage.alt = `Photo ${this.currentIndex + 1}`;
        }
        
        if (this.modalCurrentSlide) {
            this.modalCurrentSlide.textContent = this.currentIndex + 1;
        }
    }
    
    // Public methods
    destroy() {
        this.stopAutoplay();
        
        const announcement = document.getElementById('carousel-announcement');
        if (announcement) {
            announcement.remove();
        }
    }
    
    getCurrentIndex() {
        return this.currentIndex;
    }
    
    getTotalSlides() {
        return this.images.length;
    }
}

// ===== DOM ELEMENTS =====
const elements = {
    scrollTop: document.getElementById('scrollTop')
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function () {
    // Add missing CSS variable if needed
    if (!document.documentElement.style.getPropertyValue('--gray-50')) {
        document.documentElement.style.setProperty('--gray-50', '#f9fafb');
    }

    // Initialize navigation and legal functionalities from common.js
    if (window.NavigationFooter) {
        NavigationFooter.initNavigation();
        NavigationFooter.initMobileMenu();
        NavigationFooter.initScrollToTop();
        NavigationFooter.initLegalAndServices();

        // Global scroll handler
        window.addEventListener('scroll', NavigationFooter.debounce(() => {
            requestAnimationFrame(() => {
                NavigationFooter.handleScroll();
                handleScroll();
            });
        }, 10));
    }

    // Get event ID from URL and populate content
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || 'chazil';
    const event = eventData[eventId];

    if (event) {
        populateEventContent(event);
    } else {
        window.location.href = 'index.html#evenements';
    }

    // Initialize event listeners
    initEventListeners();

    // Enhanced initialization
    enhanceKeyboardNavigation();
    addAdvancedTouchSupport();
    handleResponsiveImages();
    setupLazyLoading();
    
    document.documentElement.classList.add('js-enabled');

    // Console message
    console.log('%c🎭 Bienvenue sur Euromag Fusion!', 'color: #6366f1; font-size: 24px; font-weight: bold;');
    console.log('%cSite développé par SL avec ❤️ pour promouvoir la culture algérienne', 'color: #ec4899; font-size: 14px;');
});

// ===== POPULATE EVENT CONTENT =====
function populateEventContent(event) {
    // Basic info
    document.getElementById('eventTitle').textContent = event.title;
    document.getElementById('eventDate').textContent = event.date;
    document.getElementById('eventLocation').textContent = event.location;
    document.getElementById('eventType').textContent = event.type;
    document.getElementById('breadcrumbTitle').textContent = event.title;
    document.getElementById('eventHeroBg').src = event.image;
    document.getElementById('eventHeroBg').alt = event.title;

    // Sidebar info
    document.getElementById('sidebarDate').textContent = event.date;
    document.getElementById('sidebarLocation').textContent = event.location;
    document.getElementById('sidebarTime').textContent = event.time;
    document.getElementById('sidebarPrice').textContent = event.price;

    // Full description
    document.getElementById('eventFullDescription').innerHTML = event.description;

    // Program
    populateProgram(event.program);

    // Video
    populateVideo(event.video);

    // Gallery - now using the new carousel
    populateGallery(event.gallery);

    // Update page meta information
    document.title = `${event.title} - Euromag Fusion`;
}

// ===== POPULATE PROGRAM =====
function populateProgram(program) {
    const programTimeline = document.getElementById('programTimeline');
    programTimeline.innerHTML = '';

    program.forEach(item => {
        const programItem = document.createElement('div');
        programItem.className = 'program-item';
        programItem.innerHTML = `
            <div class="program-time">${item.time}</div>
            <div class="program-title">${item.title}</div>
            <div class="program-description">${item.description}</div>
        `;
        programTimeline.appendChild(programItem);
    });
}

// ===== POPULATE VIDEO =====
function populateVideo(videoId) {
    const videoSection = document.getElementById('videoSection');
    const eventVideo = document.getElementById('eventVideo');

    if (videoId) {
        eventVideo.src = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`;
        videoSection.style.display = 'block';
    } else {
        videoSection.style.display = 'none';
    }
}

// ===== POPULATE GALLERY WITH NEW CAROUSEL =====
function populateGallery(gallery) {
    // Destroy existing carousel if it exists and has the destroy method
    if (window.galleryCarousel && typeof window.galleryCarousel.destroy === 'function') {
        window.galleryCarousel.destroy();
    }
    
    // Clear any existing carousel reference
    window.galleryCarousel = null;
    
    // Create new carousel with the gallery images
    if (gallery && gallery.length > 0) {
        window.galleryCarousel = new GalleryCarousel('galleryCarousel', gallery);
    }
}

// ===== SCROLL FUNCTIONALITY =====
function handleScroll() {
    const scrollY = window.pageYOffset || document.documentElement.scrollTop;

    // Scroll-to-top button
    if (elements.scrollTop) {
        if (scrollY > 300) {
            elements.scrollTop.classList.add('show');
        } else {
            elements.scrollTop.classList.remove('show');
        }
    }
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// ===== EVENT LISTENERS =====
function initEventListeners() {
    // Scroll events
    window.addEventListener('scroll', throttle(handleScroll, 16), { passive: true });

    // Scroll to top button
    if (elements.scrollTop) {
        elements.scrollTop.addEventListener('click', scrollToTop);
    }

    // Close modals with Escape key (legacy support)
    window.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const imageModal = document.querySelector('.image-modal');
            if (imageModal) {
                closeImageModal(imageModal);
            }
        }
    });
}

// ===== SHARE FUNCTIONS =====
function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareOnTwitter() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || 'chazil';
    const event = eventData[eventId];

    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(`${event.title} - Découvrez cet événement culturel algérien`);
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareOnLinkedIn() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
}

function shareOnWhatsApp() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || 'chazil';
    const event = eventData[eventId];

    const text = encodeURIComponent(`${event.title} - Découvrez cet événement culturel algérien ${window.location.href}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareOnTelegram() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event') || 'chazil';
    const event = eventData[eventId];

    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(`${event.title} - Découvrez cet événement culturel algérien`);
    window.open(`https://t.me/share/url?url=${url}&text=${text}`, '_blank');
}

function copyLink() {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Lien copié dans le presse-papiers !', 'success');
        }).catch(() => {
            fallbackCopyTextToClipboard(window.location.href);
        });
    } else {
        fallbackCopyTextToClipboard(window.location.href);
    }
}

// ===== FALLBACK COPY FUNCTION =====
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.width = '2em';
    textArea.style.height = '2em';
    textArea.style.padding = '0';
    textArea.style.border = 'none';
    textArea.style.outline = 'none';
    textArea.style.boxShadow = 'none';
    textArea.style.background = 'transparent';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showNotification('Lien copié dans le presse-papiers !', 'success');
    } catch (err) {
        showNotification('Impossible de copier le lien', 'error');
    }

    document.body.removeChild(textArea);
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        z-index: 3000;
        animation: slideInRight 0.3s ease;
        font-weight: 600;
        max-width: 300px;
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ===== LEGACY IMAGE MODAL SUPPORT =====
function openImageModal(imageSrc) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        cursor: pointer;
        animation: fadeIn 0.3s ease;
    `;

    const img = document.createElement('img');
    img.src = imageSrc.replace('w=300&h=200', 'w=1200&h=800');
    img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        animation: scaleIn 0.3s ease;
    `;

    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        color: #000;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    `;

    closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.background = '#ef4444';
        closeBtn.style.color = 'white';
    });

    closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.background = 'rgba(255, 255, 255, 0.9)';
        closeBtn.style.color = '#000';
    });

    modal.appendChild(img);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    const closeModal = () => closeImageModal(modal);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    closeBtn.addEventListener('click', closeModal);
}

function closeImageModal(modal) {
    modal.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => {
        if (document.body.contains(modal)) {
            document.body.removeChild(modal);
        }
        document.body.style.overflow = 'auto';
    }, 300);
}

// ===== UTILITY FUNCTIONS =====
function loadImageWithRetry(src, maxRetries = 3) {
    return new Promise((resolve, reject) => {
        let retries = 0;
        
        function attemptLoad() {
            const img = new Image();
            
            img.onload = () => resolve(img);
            img.onerror = () => {
                retries++;
                if (retries <= maxRetries) {
                    setTimeout(attemptLoad, 1000 * retries);
                } else {
                    reject(new Error(`Failed to load image after ${maxRetries} retries`));
                }
            };
            
            img.src = src;
        }
        
        attemptLoad();
    });
}

function setupLazyLoading() {
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    
                    if (src) {
                        loadImageWithRetry(src)
                            .then(() => {
                                img.src = src;
                                img.classList.remove('loading');
                                img.removeAttribute('data-src');
                            })
                            .catch(() => {
                                img.classList.add('error');
                                console.error('Failed to load image:', src);
                            });
                    }
                    
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.01
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
}

function enhanceKeyboardNavigation() {
    const carousel = document.getElementById('galleryCarousel');
    if (carousel) {
        carousel.setAttribute('tabindex', '0');
        carousel.setAttribute('role', 'region');
        carousel.setAttribute('aria-label', 'Galerie photos avec navigation au clavier');
        
        const instructions = document.createElement('div');
        instructions.className = 'sr-only';
        instructions.textContent = 'Utilisez les flèches gauche et droite pour naviguer, Entrée pour ouvrir en plein écran';
        carousel.appendChild(instructions);
    }
}

function addAdvancedTouchSupport() {
    let isPointerDown = false;
    let startX = 0;
    let currentX = 0;
    let diff = 0;
    
    const carousel = document.getElementById('galleryCarousel');
    if (!carousel) return;
    
    const track = carousel.querySelector('.carousel-track');
    if (!track) return;
    
    track.addEventListener('pointerdown', (e) => {
        isPointerDown = true;
        startX = e.clientX;
        track.style.cursor = 'grabbing';
        e.preventDefault();
    });
    
    track.addEventListener('pointermove', (e) => {
        if (!isPointerDown) return;
        
        currentX = e.clientX;
        diff = currentX - startX;
        
        if (window.galleryCarousel) {
            track.style.transform = `translateX(calc(-${window.galleryCarousel.currentIndex * 100}% + ${diff * 0.3}px))`;
        }
    });
    
    track.addEventListener('pointerup', () => {
        if (!isPointerDown) return;
        
        isPointerDown = false;
        track.style.cursor = 'grab';
        
        if (window.galleryCarousel) {
            track.style.transform = `translateX(-${window.galleryCarousel.currentIndex * 100}%)`;
            
            const threshold = 50;
            if (Math.abs(diff) > threshold) {
                if (diff > 0) {
                    window.galleryCarousel.previousSlide();
                } else {
                    window.galleryCarousel.nextSlide();
                }
            }
        }
        
        diff = 0;
    });
    
    track.addEventListener('pointerleave', () => {
        if (isPointerDown) {
            isPointerDown = false;
            track.style.cursor = 'grab';
            if (window.galleryCarousel) {
                track.style.transform = `translateX(-${window.galleryCarousel.currentIndex * 100}%)`;
            }
        }
    });
}

function handleResponsiveImages() {
    const carousel = document.getElementById('galleryCarousel');
    if (!carousel) return;
    
    function updateImageSources() {
        const images = carousel.querySelectorAll('img');
        const isLargeScreen = window.innerWidth > 1024;
        const isMediumScreen = window.innerWidth > 768;
        
        images.forEach(img => {
            const baseSrc = img.src || img.dataset.src;
            if (baseSrc) {
                let newSrc = baseSrc;
                
                if (isLargeScreen) {
                    newSrc = baseSrc.replace(/w=\d+/, 'w=1200').replace(/h=\d+/, 'h=800');
                } else if (isMediumScreen) {
                    newSrc = baseSrc.replace(/w=\d+/, 'w=800').replace(/h=\d+/, 'h=600');
                } else {
                    newSrc = baseSrc.replace(/w=\d+/, 'w=600').replace(/h=\d+/, 'h=400');
                }
                
                if (img.src !== newSrc) {
                    img.src = newSrc;
                }
            }
        });
    }
    
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateImageSources, 250);
    });
    
    updateImageSources();
}

// ===== PERFORMANCE OPTIMIZATION =====
function throttle(func, limit) {
    let inThrottle;
    return function () {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// ===== MAKE FUNCTIONS GLOBAL FOR HTML ONCLICK =====
window.shareOnFacebook = shareOnFacebook;
window.shareOnTwitter = shareOnTwitter;
window.shareOnLinkedIn = shareOnLinkedIn;
window.shareOnWhatsApp = shareOnWhatsApp;
window.shareOnTelegram = shareOnTelegram;
window.copyLink = copyLink;